# Security audit workflow for dependency scanning
# Issue #215: Automated security scanning for dependencies
#
# SECURITY NOTE: This workflow does not use any untrusted user input
# (like issue titles, PR descriptions, commit messages) in run commands.
# All inputs are from trusted sources (repository content, GitHub Actions).

name: Security Audit

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    # Run weekly on Mondays at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  security-events: write

jobs:
  audit:
    name: Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # Bun doesn't have a built-in audit command yet, so we use npm audit
      # on the package-lock.json equivalent
      - name: Run security audit
        run: |
          # Generate package-lock.json for npm audit compatibility
          npm install --package-lock-only --ignore-scripts 2>/dev/null || true

          # Run npm audit if package-lock.json was generated
          if [ -f "package-lock.json" ]; then
            npm audit --omit=dev || echo "Some vulnerabilities found, check audit output"
          else
            echo "No package-lock.json generated, minimal dependencies"
          fi

      - name: Check for known vulnerable patterns
        run: |
          # Check for common security anti-patterns in code
          echo "Checking for hardcoded secrets patterns..."

          # Look for potential secret patterns (basic check)
          # Only searches repository files, not user input
          if grep -rn --include="*.ts" --include="*.js" -E "(password|secret|api_key|apikey|token)\s*[:=]\s*['\"][^'\"]+['\"]" src/ 2>/dev/null; then
            echo "Potential hardcoded secrets found. Review the above matches."
          else
            echo "No obvious hardcoded secrets found."
          fi

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    # Only run CodeQL on main branch and PRs, not on schedule
    if: github.event_name != 'schedule'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: typescript, javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:typescript"
